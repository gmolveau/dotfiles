#!/usr/bin/env python3
"""
Renames files and folders to be more Linux-friendly by:
- Removing special characters, accents, and spaces.
- Fails silently; only return code indicates errors.
- Handles command-line arguments:
  - No argument: processes the current working directory.
  - File path: cleans the file.
  - Folder path: recursively cleans the folder.
"""

import argparse
import os
import re
import sys
import unicodedata


def clean(input_str):
    """Normalize string: remove accents, keep alphanumeric + underscores."""
    try:
        nfkd_form = unicodedata.normalize("NFKD", input_str)
        only_ascii = nfkd_form.encode("ASCII", "ignore")
        name = str(only_ascii, "utf-8")
        name = re.sub("[^0-9a-zA-Z]+", "_", name).rstrip("_")
        return name
    except Exception as e:
        return input_str  # Fallback to original if cleaning fails


def clean_file(name, filepath):
    """Rename a file to its cleaned version."""
    try:
        filename, extension = os.path.splitext(name)
        clean_filename = clean(filename)
        base = os.path.dirname(filepath)
        new_path = os.path.join(base, f"{clean_filename}{extension}")
        if new_path == filepath:
            return filepath
        else:
            os.rename(filepath, new_path)
    except Exception as e:
        sys.exit(1)  # Exit with error code if rename fails


def clean_folder(name, path):
    """Rename a folder and return its new path."""
    try:
        clean_name = clean(name)
        base = os.path.dirname(path)
        new_path = os.path.join(base, clean_name)
        os.rename(path, new_path)
        return new_path
    except Exception as e:
        sys.exit(1)  # Exit with error code if rename fails


def process_folder(path):
    """Recursively clean files and subfolders in the given path."""
    try:
        for item in os.listdir(path):
            if not item.startswith("."):  # Skip hidden files/folders
                item_path = os.path.join(path, item)
                if os.path.isfile(item_path):
                    clean_file(item, item_path)
                elif os.path.isdir(item_path):
                    new_path = clean_folder(item, item_path)
                    process_folder(new_path)
    except Exception as e:
        sys.exit(1)  # Exit with error code if processing fails


def main():
    parser = argparse.ArgumentParser(
        description="Rename files/folders to be Linux-friendly."
    )
    parser.add_argument(
        "path",
        nargs="?",
        default=os.getcwd(),
        help="File or folder path (default: current directory)",
    )
    args = parser.parse_args()

    if not os.path.exists(args.path):
        sys.exit(1)  # Exit with error code if path doesn't exist

    try:
        if os.path.isfile(args.path):
            clean_file(os.path.basename(args.path), args.path)
        elif os.path.isdir(args.path):
            process_folder(args.path)
        else:
            sys.exit(1)  # Exit with error code if path is invalid
    except Exception as e:
        sys.exit(1)  # Exit with error code for any other failure

    sys.exit(0)  # Success


if __name__ == "__main__":
    main()
